<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hlxd.microcloud.dao.InitMapper">


    <resultMap id="baseInitMap" type="com.hlxd.microcloud.vo.InitMachineTimeVo">
        <result column="machine_code" property="machineCode" />
        <result column="class_name" property="className" />
        <result column="shift_id" property="shiftId" />
        <result column="begin_date" property="beginDate" />
        <result column="end_date" property="endDate" />
    </resultMap>


    <select id="getInitMachineTime" resultMap="baseInitMap" >
        select thbm.machine_code,
        thssd.id as shift_id,
        thssd.class_name,
        STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') as begin_date,
        (
        case
        when STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') <![CDATA[>]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')        then DATE_ADD(STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s'),INTERVAL 1 DAY)
        when STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') <![CDATA[<]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')        then STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')
        end ) as end_date
        from
        t_hl_base_machine thbm
        left join t_hl_system_shift thss on thbm.shift_id = thss.id
        left join t_hl_system_shift_details thssd on thss.id = thssd.shift_id
        where
        (case
        when  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') <![CDATA[>]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')
        then now() <![CDATA[>=]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') and now() <![CDATA[<=]]>  DATE_ADD(STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s'),INTERVAL 1 DAY)
        when STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') <![CDATA[<]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')
        then now() <![CDATA[>=]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.begin_date),'%Y-%m-%d %H:%i:%s') and now() <![CDATA[<=]]>  STR_TO_DATE(concat(DATE_FORMAT(now(),'%Y-%m-%d'),' ',thssd.end_date),'%Y-%m-%d %H:%i:%s')
        end
        )
        <where>
         <if test="null != machineCode and '' != machineCode">
           and thbm.machine_code = #{machineCode}
         </if>
        </where>
    </select>

    <update id="updateMachineTime" parameterType="com.hlxd.microcloud.vo.InitMachineTimeVo">
        update t_hl_system_current_machine_time
        set begin_date =#{beginDate},end_date=#{endDate},class_name=#{className},shift_id = #{shiftId}
        where machine_code = #{machineCode}

    </update>
    <select id="getInitMachineTimeFromTable" resultMap="baseInitMap">
        select
        *
        from t_hl_system_current_machine_time
    </select>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hlxd.microcloud.dao.SoftManagementMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.hlxd.microcloud.vo.SoftManagement">
        <id column="id" property="id" />
        <result column="soft_machine_type" property="softMachineType" />
        <result column="soft_machine_name" property="softMachineName" />
        <result column="soft_name" property="softName" />
        <result column="soft_remark" property="softRemark" />
        <result column="last_version" property="lastVersion" />
        <result column="soft_upload_date" property="softUploadTime" />
        <result column="file_name" property="filePath" />
        <result column="file_path" property="fileName" />
        <collection  property="matchMachineCodes" ofType="com.hlxd.microcloud.vo.SoftManagementRecordDetails">
            <result column="match_machine_code" property="machineCode" />
            <result column="match_machine_name" property="machineName" />
            <result column="d_id" property="id" />
            <result column="soft_id" property="softId" />
        </collection>
    </resultMap>


    <insert id="insertSoftManagementRecord"  parameterType="com.hlxd.microcloud.vo.SoftManagement">
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
            select max(id)  from t_hl_soft_management
        </selectKey>
        insert into
        t_hl_soft_management
        (soft_machine_type,soft_name,soft_remark,last_version,soft_upload_date,
        file_name,file_path)
        values(#{softMachineType},#{softName},#{softRemark},#{lastVersion},now(),
        #{filePath},#{fileName}
        )
    </insert>

    <update id="updateSoftManagementRecord" parameterType="com.hlxd.microcloud.vo.SoftManagement">
        update t_hl_soft_management
        <trim prefix="set" suffixOverrides=",">
            <if test="vo.softMachineType!=null">soft_machine_type = #{vo.softMachineType},</if>
            <if test="vo.softName!=null">soft_name = #{vo.softName},</if>
            <if test="vo.softRemark!=null">soft_remark = #{vo.softRemark},</if>
            <if test="vo.lastVersion!=null">last_version = #{vo.lastVersion},</if>
        </trim>
        where id = #{vo.id}
    </update>
    
    <delete id="deleteSoftManagementRecord" parameterType="java.lang.Integer">
        delete from t_hl_soft_management
        where id = #{id}
    </delete>

    <insert id="batchAddSoftManagementRecordDetails" >
        insert into t_hl_soft_match_machine
        (soft_id,match_machine_code)
        values
        <foreach collection="addMachineCodes" item="item" index="index" separator=",">
            (#{softId},#{item})
        </foreach>
    </insert>

    <delete id ="batchDeleteSoftManagementRecordDetails">
        delete
        from t_hl_soft_match_machine
        where id in
        <foreach collection="ids" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <select id="getSoftManagement" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        select
        thsm.*,
        thsmm.id as d_id,
        thsmm.soft_id,
        thsmm.match_machine_code,
        thbm.machine_model as match_machine_name,
        thsd.key as soft_machine_name
        from
        t_hl_soft_management thsm
        left join
        t_hl_soft_match_machine thsmm
        on thsmm.soft_id = thsm.id
        left join t_hl_system_dict thsd
        on thsm.soft_machine_type = thsd.value
        left join t_hl_base_machine thbm
        on thsmm.match_machine_code = thbm.machine_code
        <trim prefix="where" prefixOverrides="AND" >
            <if test="null != id">
                AND thsm.id = #{id}
            </if>
            <if test="null != softMachineType">
                AND thsm.soft_machine_type = #{softMachineType}
            </if>
            <if test="null != softName">
                AND thsm.soft_name like CONCAT(CONCAT('%',#{softName}),'%')
            </if>
            <if test="null != lastVersion">
                AND thsm.last_version = #{lastVersion}
            </if>
            <if test="null != machineCode">
                AND thsmm.match_machine_code= #{machineCode}
            </if>
            <if test="null != validate">
                ORDER BY thsm.soft_upload_date desc limit 1
            </if>
        </trim>
    </select>



</mapper>
